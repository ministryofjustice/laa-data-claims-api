#!/bin/bash

function _uat_create_db() {
  usage="uat_create_db -- create a database in the UAT RDS instance named after the release
  Usage: scripts/uat_create_db <release-name>
  
  Example:
    scripts/uat_create_db data-claims-api-feature-xyz
  "

  set -e
  trap 'last_command=$current_command; current_command=$BASH_COMMAND' DEBUG
  trap 'echo "\"${last_command}\" command completed with exit code $?."' EXIT

  current_namespace=$(kubectl config view --minify --output 'jsonpath={..namespace}'; echo)
  if [[ ! $current_namespace =~ -uat$ ]]; then
    echo "namespace must be UAT!" >&2
    return 1
  fi

  if [[ $# -ne 1 ]]; then
    echo "$usage"
    return 1
  else
    RELEASE_NAME=$1
  fi

  # Validate database name length (PostgreSQL limit is 63 characters)
  if [[ ${#RELEASE_NAME} -gt 63 ]]; then
    echo "ERROR: Database name '${RELEASE_NAME}' exceeds PostgreSQL's 63-character limit (${#RELEASE_NAME} chars)" >&2
    return 1
  fi

  echo 'Retrieve RDS credentials'
  DB_HOST=$(kubectl get secret rds-postgresql-instance-output -o jsonpath="{.data.rds_instance_address}" | base64 --decode)
  DB_NAME=$(kubectl get secret rds-postgresql-instance-output -o jsonpath="{.data.database_name}" | base64 --decode)
  DB_USER=$(kubectl get secret rds-postgresql-instance-output -o jsonpath="{.data.database_username}" | base64 --decode)
  DB_PWD=$(kubectl get secret rds-postgresql-instance-output -o jsonpath="{.data.database_password}" | base64 --decode)

  echo "Checking if port-forward-pod exists"
  FORWARDING_POD=$(kubectl get pods | grep -m1 port-forward-pod | head -n1 | cut -d' ' -f 1 || true)
  if [[ -z "$FORWARDING_POD" ]]; then
    echo 'Creating new port-forward-pod...'
    kubectl run port-forward-pod \
      --image=ministryofjustice/port-forward \
      --port=5432 \
      --env="REMOTE_HOST=${DB_HOST}" \
      --env="LOCAL_PORT=5432" \
      --env="REMOTE_PORT=5432"
  fi

  echo 'Waiting for port-forward-pod to be ready...'
  kubectl wait --for=condition=ready pod port-forward-pod --timeout=60s

  echo 'Starting port-forwarding as a background job'
  kubectl port-forward port-forward-pod 5433:5432 &
  PF_PID=$!

  sleep 5

  echo "Creating database: ${RELEASE_NAME}"
  for i in {1..3}; do
    echo "Attempt: $i"
    
    # Check if database already exists
    GET_QUERY="SELECT datname FROM pg_database WHERE datname = '${RELEASE_NAME}'"
    EXISTING_DB=$(psql postgres://"${DB_USER}":"${DB_PWD}"@localhost:5433/"${DB_NAME}" -qtc "${GET_QUERY};" | xargs || true)
    
    if [[ -n "${EXISTING_DB}" ]]; then
      echo "Database ${RELEASE_NAME} already exists!"
      break
    else
      CREATE_DB_CMD="CREATE DATABASE \"${RELEASE_NAME}\";"
      CREATE_DB_OUTPUT=$(psql postgres://"${DB_USER}":"${DB_PWD}"@localhost:5433/"${DB_NAME}" -c "${CREATE_DB_CMD};" || true)
      
      CREATED=$(echo "$CREATE_DB_OUTPUT" | grep -c 'CREATE DATABASE' || true)
      if [[ $CREATED == 1 ]]; then
        echo "Created database ${RELEASE_NAME}!"
        break
      else
        echo "Failed to create database, retrying..."
        sleep 2
      fi
    fi
  done

  echo 'Killing port-forwarding background job'
  kill $PF_PID || true

  echo 'Deleting port-forwarding pod'
  kubectl delete pod port-forward-pod --wait=false || true
}

_uat_create_db $@
