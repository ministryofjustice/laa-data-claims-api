#!/bin/bash

function _uat_drop_db() {
  usage="uat_drop_db -- drop a database in the UAT RDS instance
  Usage: scripts/uat_drop_db <release-name>
  DANGER: This will delete the database permanently
  
  Example:
    scripts/uat_drop_db data-claims-api-feature-xyz
  "

  set -e
  trap 'last_command=$current_command; current_command=$BASH_COMMAND' DEBUG
  trap 'echo "\"${last_command}\" command completed with exit code $?."' EXIT

  current_namespace=$(kubectl config view --minify --output 'jsonpath={..namespace}'; echo)
  if [[ ! $current_namespace =~ -uat$ ]]; then
    echo "namespace must be UAT!" >&2
    return 1
  fi

  if [[ $# -ne 1 ]]; then
    echo "$usage"
    return 1
  else
    RELEASE_NAME=$1
  fi

  # Validate database name length (PostgreSQL limit is 63 characters)
  if [[ ${#RELEASE_NAME} -gt 63 ]]; then
    echo "ERROR: Database name '${RELEASE_NAME}' exceeds PostgreSQL's 63-character limit (${#RELEASE_NAME} chars)" >&2
    return 1
  fi

  echo 'Retrieve RDS credentials'
  DB_HOST=$(kubectl get secret rds-postgresql-instance-output -o jsonpath="{.data.rds_instance_address}" | base64 --decode)
  DB_NAME=$(kubectl get secret rds-postgresql-instance-output -o jsonpath="{.data.database_name}" | base64 --decode)
  DB_USER=$(kubectl get secret rds-postgresql-instance-output -o jsonpath="{.data.database_username}" | base64 --decode)
  DB_PWD=$(kubectl get secret rds-postgresql-instance-output -o jsonpath="{.data.database_password}" | base64 --decode)

  # Prevent dropping critical databases
  case "$RELEASE_NAME" in
    rdsadmin | template0 | template1 | postgres | main | $DB_NAME)
      echo "ERROR: Cannot drop protected database \"$RELEASE_NAME\"!" >&2
      return 1
      ;;
    *)
      ;;
  esac

  echo "Checking if port-forward-pod exists"
  FORWARDING_POD=$(kubectl get pods | grep -m1 port-forward-pod | head -n1 | cut -d' ' -f 1 || true)
  if [[ -z "$FORWARDING_POD" ]]; then
    echo 'Creating new port-forward-pod...'
    kubectl run port-forward-pod \
      --image=ministryofjustice/port-forward \
      --port=5432 \
      --env="REMOTE_HOST=${DB_HOST}" \
      --env="LOCAL_PORT=5432" \
      --env="REMOTE_PORT=5432"
  fi

  echo 'Waiting for port-forward-pod to be ready...'
  kubectl wait --for=condition=ready pod port-forward-pod --timeout=60s

  echo 'Starting port-forwarding as a background job'
  kubectl port-forward port-forward-pod 5433:5432 &
  PF_PID=$!

  sleep 5

  # Terminate app pods to close connections
  echo "Checking for app pods to terminate..."
  APP_PODS=$(kubectl get pods -l app.kubernetes.io/instance="${RELEASE_NAME}" -o name || true)
  if [[ -n "$APP_PODS" ]]; then
    echo "Terminating pods: ${APP_PODS}"
    kubectl delete $APP_PODS --wait=false || true
    sleep 5
  fi

  echo "Dropping database: ${RELEASE_NAME}"
  for i in {1..3}; do
    echo "Attempt: $i"
    
    GET_QUERY="SELECT datname FROM pg_database WHERE datname = '${RELEASE_NAME}'"
    DATABASE_TO_DROP=$(psql postgres://"${DB_USER}":"${DB_PWD}"@localhost:5433/"${DB_NAME}" -qtc "${GET_QUERY};" | xargs || true)
    
    if [[ -z "${DATABASE_TO_DROP}" ]]; then
      echo "Database ${RELEASE_NAME} not found!"
      break
    fi

    # Prevent new connections
    ALTER_CONN_LIMIT="ALTER DATABASE \"${DATABASE_TO_DROP}\" CONNECTION LIMIT 0;"
    psql postgres://"${DB_USER}":"${DB_PWD}"@localhost:5433/"${DB_NAME}" -qtc "${ALTER_CONN_LIMIT};" || true

    # Terminate existing connections
    CLOSE_CONN_QUERY="SELECT pg_terminate_backend(pid) FROM pg_stat_activity WHERE datname = '${DATABASE_TO_DROP}'"
    psql postgres://"${DB_USER}":"${DB_PWD}"@localhost:5433/"${DB_NAME}" -qtc "${CLOSE_CONN_QUERY};" || true

    sleep 2

    # Drop the database
    DROP_DATABASE_CMD="DROP DATABASE \"${DATABASE_TO_DROP}\";"
    DROP_DATABASE_OUTPUT=$(psql postgres://"${DB_USER}":"${DB_PWD}"@localhost:5433/"${DB_NAME}" -c "${DROP_DATABASE_CMD};" || true)

    DROPPED=$(echo "$DROP_DATABASE_OUTPUT" | grep -c 'DROP DATABASE' || true)
    if [[ $DROPPED == 1 ]]; then
      echo "Successfully dropped database ${DATABASE_TO_DROP}!"
      break
    else
      echo "Failed to drop database, retrying..."
      sleep 2
    fi
  done

  echo 'Killing port-forwarding background job'
  kill $PF_PID || true

  echo 'Deleting port-forwarding pod'
  kubectl delete pod port-forward-pod --wait=false || true
}

_uat_drop_db $@
